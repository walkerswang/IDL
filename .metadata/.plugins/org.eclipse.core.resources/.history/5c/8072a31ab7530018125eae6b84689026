read_ampere_ncdf,'/Users/wzihan/Downloads/2013/20130518Amp_invert.ncdf',time,pseudosvnum,plane_number,pos_eci,b_eci,pseudo_sv_quality,data_splice
pos_eci=transpose(pos_eci)
b_eci=transpose(b_eci)

pos_geo=fltarr(302228,3)
b_mag=dblarr(302228,3)
b_enu=dblarr(302228,3)
mlt=fltarr(302228,1)
sc=0
list=[]
for i=0, 0 do begin
;  if i gt 0 then begin
;    if time[i] lt time[i-1] then begin
;      sc=sc+1
;      if n_elements(list) gt 0 then begin
;        ti='SC='+strcompress(string(sc))+'  UT='+strcompress(string(time[list[0]]))+'  MLT='+strcompress(string(mlt[list[0]]))+'  BLACK: EAST BLUE: NORTH, RED: UPWARD'
;        p=plot(pos_mag[list,1],b_enu[list,0], xrange=[40,70], yrange=[-150,150],title=ti, xtitle='MLAT',ytitle='B (nT)')
;        p=plot(pos_mag[list,1],b_enu[list,1],'-b',/overplot)
;        p=plot(pos_mag[list,1],b_enu[list,2],'-r',/overplot)
;        p.save,  strcompress(string(sc))+'SC.png'
;        p.close
;        list=[]
;      endif
;    endif
;  endif
  hour=floor(time[i])
  minute=floor((time[i]-hour)*60)
  second=floor((time[i]-hour-float(minute/60.0))*3600)
  geopack_recalc,2013,5,18,hour,minute,second,/DATE
  geopack_conv_coord, pos_eci[i,0],  pos_eci[i,1], pos_eci[i,2],a,b,c, /from_gei,/to_geo
  geopack_sphcar, a, b, c, r, theta, phi, /to_sphere, /degree
  pos_geo[i,0]=r
  pos_geo[i,1]=180-theta
  pos_geo[i,2]=phi
;  geopack_conv_coord, b_eci[i,0],  b_eci[i,1], b_eci[i,2],d,e,f, /from_gei,/to_mag
;  b_mag[i,0]=d
;  b_mag[i,1]=e
;  b_mag[i,2]=f
;  r=sqrt(a*a+b*b+c*c)
;  pos_mag[i,0]=(r-6370000)/1000
;  pos_mag[i,1]=90-acos(c/r)/!pi*180
;  pos_mag[i,2]=atan(b/a)/!pi*180
;  if a lt 0 then begin
;    pos_mag[i,2]=pos_mag[i,2]+180   
;  endif
;  pos_mag[i,2]=pos_mag[i,2]+180
;  mlt[i]=time[i]+(pos_mag[i,2]-72.63)/15
;  mlt[i]=mlt[i] mod 24
;  
;  theta=pos_mag[i,1]/180*!pi
;  phi=pos_mag[i,2]/180*!pi
;  matrix=[[-sin(phi),cos(phi),0],[-cos(theta)*cos(phi),-cos(theta)*sin(phi),sin(theta)],[sin(theta)*cos(phi),sin(theta)*sin(phi),cos(theta)]]
;  b_enu[i,*]=matrix##b_mag[i,*]
  
;  if (mlt[i] lt 21) and (mlt[i] gt 17) and (time[i] gt 4.5) and (time[i] lt 5.5) and (pos_mag[i,1] gt 40) and (pos_mag[i,1] lt 70) then begin
;    list=[list,i]
;  endif
endfor

;sc=sc+1
;if n_elements(list) gt 0 then begin
;  ti='SC='+strcompress(string(sc))+'  UT='+strcompress(string(time[list[0]]))+'  MLT='+strcompress(string(mlt[list[0]]))+'  BLACK: EAST BLUE: NORTH, RED: UPWARD'
;  p=plot(pos_mag[list,1],b_enu[list,0], xrange=[40,70], yrange=[-150,150],title=ti, xtitle='MLAT',ytitle='B (nT)')
;  p=plot(pos_mag[list,1],b_enu[list,1],'-b',/overplot)
;  p=plot(pos_mag[list,1],b_enu[list,2],'-r',/overplot)
;  p.save,  strcompress(string(sc))+'SC.png'
;  p.close
;endif
end